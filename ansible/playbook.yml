---
- name: Self-Healing Web Server Playbook
  hosts: localhost
  gather_facts: yes
  vars:
    # Project path mapped in the container
    project_dir: /project
    web_service_name: web
    desired_replicas: 3
    website_dir: /usr/share/nginx/html
    
  tasks:
    # 1. Enforce State using Docker Compose
    # This automatically heals missing containers and ensures the count is correct
    - name: Ensure {{ desired_replicas }} replicas of web service are running
      shell: |
        cd {{ project_dir }} && docker compose up -d --scale {{ web_service_name }}={{ desired_replicas }} --no-recreate
      register: compose_scale
      changed_when: "'Created' in compose_scale.stdout or 'Recreating' in compose_scale.stdout"

    - name: Notify Discord of Container Healing
      uri:
        url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
        method: POST
        body_format: json
        body:
          content: "üöë **Self-Healing Alert!**\nDetected missing containers. Ansible has successfully restored the cluster state.\n> **Action:** Recreated {{ compose_scale.stdout_lines | select('search', 'Created|Recreating|Started') | list | count }} container(s)."
      when: compose_scale.changed and lookup('env', 'DISCORD_WEBHOOK_URL') != ""
      ignore_errors: yes

    # 2. Verify and Heal Content (in ALL web containers)
    - name: Get list of all web container IDs
      shell: |
        docker ps --filter "label=com.docker.compose.project=s" --filter "label=com.docker.compose.service={{ web_service_name }}" --format "{{ '{{' }}.ID{{ '}}' }}"
      register: web_containers
      changed_when: false

    - name: Check Health in each container
      shell: "docker exec {{ item }} wget -q --spider http://localhost:3000"
      register: health_check
      ignore_errors: yes
      loop: "{{ web_containers.stdout_lines }}"
      changed_when: false

    - name: Notify Discord if Health Check Fails
      uri:
        url: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"
        method: POST
        body_format: json
        body:
          content: "‚ö†Ô∏è **Health Check Warning**\nContainer `{{ item.item }}` failed HTTP check on port 3000."
      when: item.rc != 0 and lookup('env', 'DISCORD_WEBHOOK_URL') != ""
      loop: "{{ health_check.results }}"
      ignore_errors: yes

    - name: Display status
      debug:
        msg: "Healing complete. {{ web_containers.stdout_lines | length }} web containers are running."
