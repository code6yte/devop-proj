---
- name: Self-Healing Web Server Playbook
  hosts: localhost
  gather_facts: yes
  vars:
    # Project path mapped in the container
    project_dir: /project
    web_service_name: web
    desired_replicas: 3
    website_dir: /usr/share/nginx/html
    
  tasks:
    # 1. Enforce State using Docker Compose
    # This automatically heals missing containers and ensures the count is correct
    - name: Ensure {{ desired_replicas }} replicas of web service are running
      shell: |
        docker compose -p devop_healing -f {{ project_dir }}/docker-compose.yml up -d --scale {{ web_service_name }}={{ desired_replicas }} --no-recreate
      register: compose_scale
      changed_when: "'Created' in compose_scale.stdout or 'Recreating' in compose_scale.stdout"

    # 2. Verify and Heal Content (in ALL web containers)
    - name: Get list of all web container IDs
      shell: |
        docker ps --filter "label=com.docker.compose.service={{ web_service_name }}" --format "{{ '{{' }}.ID{{ '}}' }}"
      register: web_containers
      changed_when: false

    - name: Check and Restore index.html in each container
      include_tasks: inner_heal.yml
      loop: "{{ web_containers.stdout_lines }}"
      loop_control:
        loop_var: container_id

    - name: Display status
      debug:
        msg: "Healing complete. {{ web_containers.stdout_lines | length }} web containers are running."
